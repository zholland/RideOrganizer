/**
 * Created by EmilyMillard on 15-02-22.
 */
  <% environment.context_class.instance_eval { include Rails.application.routes.url_helpers } %>

var rendererOptions = {
    draggable: true
};

//var directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);
//var directionsService = new google.maps.DirectionsService();
//var map;

var routeArray = [];
var tripDestination;
//var map;


var kelowna = new google.maps.LatLng(49.887952, -119.496011);


function initialize(routeNum) {

    // Create a map and center it on Kelowna.
    var mapOptions = {
        zoom: 10,
        center: kelowna
    }

    var map = new google.maps.Map(document.getElementById('map-canvas-'+routeNum), mapOptions);
    window['map_'+routeNum]=map;

    var directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);
    var directionsService = new google.maps.DirectionsService();

    directionsDisplay.setMap(map);
    directionsDisplay.setPanel(document.getElementById('directionsPanel-'+routeNum));

    google.maps.event.addListener(directionsDisplay, 'directions_changed', function() {
    //    computeTotalDistance(directionsDisplay.getDirections());
    });

    calcRoute(directionsDisplay, directionsService);
}

function loadTrip() {
    $.ajax({
        url: 'trip_plans/get_travellers',
        type: 'POST',
        success: function (data) {
            getRoutes(data);
        }
    });
}

function getRoutes(tripData) {
    var tripsArray = tripData;
    tripDestination = tripsArray.destination_address;
    var date = tripsArray.date_time;

    var routesArray = tripsArray.routes;
    var numRoutes = routesArray.length;

    var currRoute = 1;

    for (var i=0; i<numRoutes; i++) {
        routeArray = routesArray[i];

        var liNode = document.createElement("li");
        var hrefNode = document.createElement("a");
        hrefNode.setAttribute('href', "#tab-"+currRoute);
        var routeNumNode = document.createTextNode("Route: "+currRoute);

        if (i == 0) {
            liNode.setAttribute("class", "current");
        }

        hrefNode.appendChild(routeNumNode);
        liNode.appendChild(hrefNode);

        document.getElementsByClassName("tabs-menu")[0].appendChild(liNode);

        var tabDiv = document.createElement("div");
        tabDiv.setAttribute("class", "tab-content");
        tabDiv.setAttribute("id", "tab-"+currRoute);

        var mapCon = document.createElement("div");
        mapCon.setAttribute("id", "map-container");
        mapCon.setAttribute("style", "width:100%");

        var mapCan = document.createElement("div");
        mapCan.setAttribute("id", "map-canvas-"+currRoute);
        mapCan.setAttribute("class", "map-canvas");
        mapCan.setAttribute("style", "width:100%");

        mapCon.appendChild(mapCan);
        tabDiv.appendChild(mapCon);

        var directionsPan = document.createElement("div");
        directionsPan.setAttribute("id", "directionsPanel-"+currRoute);

        document.getElementsByClassName("tab")[0].appendChild(tabDiv).appendChild(directionsPan);

        initialize(currRoute);

        currRoute++;


    }

        jQuery(document).ready(function() {
            jQuery(".tabs-menu a").click(function(event) {
                event.preventDefault();
                jQuery(this).parent().addClass("current");
                jQuery(this).parent().siblings().removeClass("current");
                var tab = jQuery(this).attr("href");
                jQuery(".tab-content").not(tab).css("display", "none");
                jQuery(tab).fadeIn();

                console.log(tab)

                var mapInt = 0;

                for (var i = 0, len = tab.length; i < len; i++) {
                    if (tab[i] == '-') {
                        mapInt = tab.substring(i+1, tab.length);
                        break;
                    }
                }
                google.maps.event.trigger(window['map_'+mapInt], 'resize');
                window['map_'+mapInt].setCenter(kelowna);
                window['map_'+mapInt].setZoom(10);
            });

        });


}

function calcRoute(directionsDisplay, directionsService) {

    var waypointsArray = [];
    var passengersArray = routeArray["passengers"];

    for (var i=0; i<passengersArray.length; i++) {
        console.log(passengersArray[i]);

        waypointsArray.push({
            location:passengersArray[i].address,
            stopover:true
        });
    }

    var request = {
        origin: routeArray.driver.address,
        destination: tripDestination,
        waypoints:waypointsArray,
        optimizeWaypoints: true,
        travelMode: google.maps.TravelMode.DRIVING
    };
    directionsService.route(request, function(response, status) {
        if (status == google.maps.DirectionsStatus.OK) {
            directionsDisplay.setDirections(response);
        } else {
            console.log("directions didn't work");
        }

    });
}

function computeTotalDistance(result) {
    var total = 0;
    var myroute = result.routes[0];
    for (var i = 0; i < myroute.legs.length; i++) {
        total += myroute.legs[i].distance.value;
    }
    total = total / 1000.0;
    document.getElementById('total').innerHTML = total + ' km';
}

google.maps.event.addDomListener(window, 'load', loadTrip);
